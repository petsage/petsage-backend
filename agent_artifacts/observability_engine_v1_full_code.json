{
  "feature": "observability_engine_v1_full_code",
  "description": "Generate the complete production-grade code implementation for the PetSage Observability, Safety, Governance, and Audit Engine based on the blueprint in petsage_observability_safety_governance_audit_pipeline_v1.json. This must include all modules, full logic, docstrings, Pydantic models, internal classes, exception handling, integration guidelines, and PDF/JSON exporters. No placeholders, no stubs, no TODOs.",
  "requirements": [
    "=== 1. CREATE THE DIRECTORY STRUCTURE ===",
    "Create a new top-level folder observability_engine/ with submodules:",
    " \u2022 logging_interceptor.py",
    " \u2022 reasoning_tracer.py",
    " \u2022 audit_exporter.py",
    " \u2022 safety_scoring.py",
    " \u2022 drift_detection.py",
    " \u2022 anomaly_detector.py",
    " \u2022 metrics_pipeline.py",
    " \u2022 cost_analytics.py",
    " \u2022 governance_controls.py",
    " \u2022 compliance_engine.py",
    "Each file must contain full, correct, runnable Python code.",
    "=== 2. LOGGING INTERCEPTOR MODULE ===",
    "Implement an async LoggingInterceptor class that wraps FastAPI endpoints to capture:",
    " \u2022 request metadata",
    " \u2022 response data",
    " \u2022 latency metrics",
    " \u2022 errors with traceback",
    " \u2022 engine hops",
    " \u2022 safety triggers",
    "Output logs to structured JSON, Cloud Logging, and GCS (petsage-logs/...).",
    "Include a correlation_id generator and sanitization routines.",
    "=== 3. REASONING TRACER MODULE ===",
    "Record internal reasoning summaries (chain-of-thought-style but sanitized).",
    "Track: entities, RAG sources, confidence, fallback paths, safety flags.",
    "Store compressed JSONL traces under petsage-reasoning-traces/YYYY/MM/DD.",
    "Include timestamping, schema validation, and safe default fallbacks.",
    "=== 4. AUDIT EXPORTER ===",
    "Generate audit bundles in BOTH JSONL and PDF formats.",
    "Use reportlab for PDF bundled reports: inputs, outputs, safety scores, red flags, reasoning summaries, RAG citations, timestamps.",
    "Export to GCS under petsage-audit-bundles/ with unique correlation_id filenames.",
    "=== 5. SAFETY SCORING ENGINE ===",
    "Implement detailed risk scoring:",
    " \u2022 hallucination risk",
    " \u2022 red-flag trigger density",
    " \u2022 fallback-path frequency",
    " \u2022 confidence stability",
    " \u2022 severity weighting",
    "Produce a unified 0\u2013100 safety_score field.",
    "Document formulas fully.",
    "=== 6. DRIFT DETECTION ===",
    "Detect distribution shifts in:",
    " \u2022 symptoms",
    " \u2022 species",
    " \u2022 languages",
    " \u2022 severity levels",
    " \u2022 model outputs",
    "Write drift reports to GCS petsage-drift-reports/ with JSON diff snapshots.",
    "=== 7. ANOMALY DETECTOR ===",
    "Implement anomaly detection for:",
    " \u2022 repeated unusual responses",
    " \u2022 missing expected red flags",
    " \u2022 extremely low confidence",
    " \u2022 symptom incompatibility",
    "Output anomalies into observability_engine/anomalies/*.json.",
    "=== 8. METRICS PIPELINE ===",
    "Collect usage metrics, engine latency, token usage (if available), request volumes, red-flag frequency, species/language breakdowns.",
    "Expose as Prometheus textfile metrics + write snapshots to petsage-metrics/.",
    "=== 9. COST ANALYTICS ENGINE ===",
    "Estimate costs per-request using token estimates and engine profiles.",
    "Track free vs premium paths, monthly projections, drift-adjusted burn.",
    "Write reports to petsage-cost-reports/.",
    "=== 10. GOVERNANCE CONTROLS ===",
    "Enforce:",
    " \u2022 mandatory safety checks",
    " \u2022 maximum reasoning depth",
    " \u2022 consistent model versions",
    " \u2022 emergency fallbacks on anomaly detection",
    "Integrate with audit and compliance modules.",
    "=== 11. COMPLIANCE ENGINE (EU AI Act, ISO 27001, NIS2, DORA) ===",
    "Implement compliance scoring and full documentation exporters:",
    " \u2022 EU AI Act transparency, oversight, robustness, risk management",
    " \u2022 ISO 27001 Annex A mapping",
    " \u2022 NIS2 governance & reporting",
    " \u2022 DORA resilience & continuity",
    "Output compliance bundles in JSON and PDF.",
    "=== 12. DOCUMENTATION & INTEGRATION GUIDE ===",
    "Generate README.md and integration docs:",
    " \u2022 How to plug LoggingInterceptor into FastAPI",
    " \u2022 How to call ReasoningTracer from triage orchestrator (later)",
    " \u2022 How to enable PDF audit exporting",
    " \u2022 How drift detection should be scheduled weekly",
    " \u2022 How to configure Cloud Monitoring dashboards",
    "No placeholders. Full detailed instructions.",
    "=== 13. OUTPUT LOCATION ===",
    "Write all generated .py files to agent_artifacts/observability_engine_v1_code/ for review.",
    "The code must be fully functional and ready for deployment once integrated.",
    "=== 14. RULES ===",
    "Do NOT modify triage_engine/, the mobile builder repos, or any running 48-hour intelligence build.",
    "All modules must be self-contained, namespaced, and deploy-ready."
  ],
  "status": "builder pipeline success"
}