{
  "feature": "petsage_observability_safety_governance_audit_pipeline_v1",
  "description": "Build the complete PetSage enterprise-grade Observability, Safety, Governance, and Audit Intelligence Pipeline. This must be a full, finished, production-ready subsystem designed for global veterinary triage operations, regulatory compliance, clinical governance, reliability engineering, and audit traceability. It must NOT modify triage_engine/, must NOT touch the 48h build job, and must NOT interfere with the agentic UI/mobile pipeline.",
  "requirements": [
    "=== 1. ARCHITECTURE & DIRECTORY STRUCTURE ===",
    "Create a completely independent top-level module: observability_engine/",
    "Within this folder create the following submodules with full code, documentation, and typed Pydantic models:",
    " \u2022 logging_interceptor/",
    " \u2022 reasoning_tracer/",
    " \u2022 audit_exporter/",
    " \u2022 safety_scoring/",
    " \u2022 drift_detection/",
    " \u2022 anomaly_detector/",
    " \u2022 metrics_pipeline/",
    " \u2022 cost_analytics/",
    " \u2022 governance_controls/",
    " \u2022 compliance_engine/",
    "All modules must be fully implemented, production-ready, tested and documented within artifact files.",
    "=== 2. CENTRAL LOGGING INTERCEPTOR (REAL IMPLEMENTATION) ===",
    "Implement an async LoggingInterceptor class that can wrap ANY FastAPI endpoint.",
    "Capture: request body, response body, latency, HTTP status, internal errors, engine hops, internal fallbacks, safety triggers, reasoning steps, warnings, red flags.",
    "Store structured logs to JSONL lines with timestamp, correlation_id, user_id (if any), species, language, symptoms, output triage categories, latency breakdowns.",
    "Emit logs to: (a) Cloud Logging structured entries, (b) GCS under petsage-logs/YYYY/MM/DD/*.jsonl.",
    "Absolutely NO placeholders. Full working code.",
    "=== 3. FULL REASONING TRACE RECORDER (SANITIZED & SAFE) ===",
    "Implement a ReasoningTracer module that records internal chain-of-thought style reasoning, BUT sanitizes personal data and removes sensitive identifiers.",
    "Record: extracted entities, RAG citations, model reasoning summaries, confidence scores, decision paths, red-flag triggers, fallback logic.",
    "Store results under GCS bucket petsage-reasoning-traces/ with per-case JSONL bundles.",
    "Must include compression (gzip) and error-handling.",
    "=== 4. AUDIT EXPORTER (REGULATOR-GRADE) ===",
    "Implement an AuditExporter that generates both JSONL bundles AND PDF bundles using reportlab.",
    "PDF bundles must include: timestamp, full reasoning trace, safety triggers, red flags, next steps, RAG references, decision quality indicators, latency metrics, species metadata, input sanitization summary.",
    "Must fully support EU AI Act auditability, ISO 27001 traceability, NIS2 reporting, DORA operational continuity, and veterinary clinical governance standards.",
    "This file must be fully built, not a stub.",
    "=== 5. SAFETY SCORING ENGINE ===",
    "Implement a SafetyScoreEngine that computes:",
    " \u2022 hallucination_risk_score (0-1)",
    " \u2022 clinical_severity_risk_score",
    " \u2022 red_flag_trigger_count score",
    " \u2022 fallback_path_probability",
    " \u2022 confidence_stability_score",
    " \u2022 language_quality_score",
    "Produce a combined safety index 0-100.",
    "Document formulas. No placeholders.",
    "=== 6. DRIFT DETECTION ENGINE ===",
    "Implement drift detection using embeddings + statistical distribution shift:",
    "Detect: symptom drift, language drift, species drift, severity drift, model output drift, latency drift.",
    "Store drift summaries under petsage-drift-reports/.",
    "=== 7. ANOMALY DETECTOR ===",
    "Implement an anomaly detection system to flag:",
    " \u2022 repeated unusual outputs",
    " \u2022 unexpected model behaviour",
    " \u2022 low-confidence reasoning patterns",
    " \u2022 missing red flags where expected",
    " \u2022 impossible symptom combinations",
    "Output anomalies to observability_engine/anomalies/YYYYMMDD_report.json.",
    "=== 8. METRICS PIPELINE ===",
    "Generate a metrics collector that exports real metrics:",
    " \u2022 latency per engine",
    " \u2022 network latency",
    " \u2022 cold start timings",
    " \u2022 cost-per-request",
    " \u2022 species/language distribution",
    " \u2022 red-flag frequency",
    " \u2022 follow-up question triggers",
    "Export to: Cloud Monitoring, Prometheus-format textfile, GCS snapshots.",
    "=== 9. COST ANALYTICS ENGINE ===",
    "Implement a cost breakdown module for AI inference:",
    " \u2022 per-token cost",
    " \u2022 per-engine cost",
    " \u2022 per-user cohort cost",
    " \u2022 free vs premium tier burn",
    " \u2022 daily + monthly projections",
    "Output to petsage-cost-reports/ in GCS.",
    "=== 10. GOVERNANCE CONTROLS ENGINE ===",
    "Implement controls that enforce:",
    " \u2022 maximum reasoning depth",
    " \u2022 maximum follow-up chains",
    " \u2022 mandatory safety checks",
    " \u2022 model version tagging",
    " \u2022 environment stamping",
    "These must integrate with AuditExporter and ReasoningTracer.",
    "=== 11. EU AI ACT / ISO 27001 / NIS2 / DORA COMPLIANCE MODULE ===",
    "Implement a ComplianceEngine that outputs structured compliance scores for:",
    " \u2022 EU AI Act Annex III veterinary triage category",
    " \u2022 EU AI Act transparency, human oversight, safety, risk management",
    " \u2022 ISO 27001 Annex A controls applied",
    " \u2022 NIS2 governance rules",
    " \u2022 DORA operational resilience requirements",
    "Produce compliance summary JSON and PDF using reportlab.",
    "=== 12. OUTPUT LOCATIONS ===",
    "All generated code artifacts must be placed under:",
    "agent_artifacts/observability/v1/",
    "Each file must be complete, clean, production-ready.",
    "=== 13. INTEGRATION DOCS (MANDATORY) ===",
    "Generate a full integration guide explaining how to:",
    " \u2022 integrate LoggingInterceptor into FastAPI",
    " \u2022 attach ReasoningTracer to internal pipeline",
    " \u2022 link SafetyScoreEngine to triage outputs",
    " \u2022 export audits to regulators",
    " \u2022 schedule drift detection weekly",
    " \u2022 read dashboards in Cloud Monitoring",
    "No placeholders. Full instructions.",
    "=== 14. ABSOLUTE RULES ===",
    "No modification of triage_engine/, mobile UI repos, intelligence 48h build jobs, or active pipelines.",
    "Everything must be standalone, safe, production-ready, and non-overlapping.",
    "No stubs, no TODOs, no placeholders, no vague interfaces. Full code only."
  ],
  "status": "builder pipeline success"
}